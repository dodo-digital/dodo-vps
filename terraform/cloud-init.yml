#cloud-config
# Initial server setup via cloud-init

hostname: ${server_name}

users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys: []

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - vim
  - htop
  - tmux
  - ufw
  - fail2ban
  - software-properties-common
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release
  - build-essential

runcmd:
  # Basic firewall setup
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

  # Basic fail2ban config
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Create welcome message
  - |
    cat > /etc/update-motd.d/99-agent-vps << 'MOTD'
    #!/bin/bash
    echo ""
    echo "========================================"
    echo "  Coding Agent VPS - Ready for setup"
    echo "========================================"
    echo ""
    echo "Run the setup script:"
    echo "  curl -fsSL https://raw.githubusercontent.com/dodo-digital/dodo-vps/main/setup.sh -o setup.sh"
    echo "  chmod +x setup.sh"
    echo "  sudo ./setup.sh --on-server"
    echo ""
    MOTD
  - chmod +x /etc/update-motd.d/99-agent-vps

final_message: "Server initialization complete. Run 'ssh ubuntu@<ip>' to connect."
